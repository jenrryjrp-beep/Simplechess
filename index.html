<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Lab v7.7 - Fix Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-body: #05070a; --bg-card: #0f1216; --accent: #00a8ff;
            --text-high: #ffffff; --border: #1e252b; --board-size: 520px;
        }

        html, body { background: var(--bg-body); color: var(--text-high); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw; }
        .app-container { width: 100%; height: 100%; display: grid; grid-template-columns: 1fr 400px; padding: 15px; gap: 20px; box-sizing: border-box; }
        @media (max-width: 950px) { .app-container { grid-template-columns: 1fr; overflow-y: auto; height: auto; } }

        .board-frame { width: 100%; max-width: 450px; margin: 0 auto; position: relative; }
        #chessBoard { border: 4px solid var(--border); border-radius: 8px; }

        .analysis-section { background: var(--bg-card); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); }
        #comment-display { padding: 15px; background: #12151a; color: var(--accent); font-size: 14px; border-left: 4px solid var(--accent); min-height: 50px; }
        #notation-engine { flex-grow: 1; padding: 20px; overflow-y: auto; background: #080a0d; line-height: 2.5; font-size: 15px; }
        
        .m-link { color: #8892b0; cursor: pointer; padding: 2px 5px; border-radius: 4px; }
        .m-active { background: var(--accent); color: #000; font-weight: bold; }
        .comm-inline { display: block; font-size: 12px; color: #64748b; font-style: italic; padding-left: 10px; border-left: 2px solid #1e252b; margin: 5px 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; }
        .input-pro { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 8px; margin-bottom: 12px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
        .btn-main { background: var(--accent); color: #000; width: 100%; padding: 15px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="board-section">
            <div id="match-result" style="text-align:center; color:var(--accent); font-weight:900; margin-bottom:10px">ANALIZANDO PARTIDA</div>
            <div class="board-frame">
                <div id="chessBoard"></div>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-top:15px">
                <button style="padding:15px; background:#161b22; color:#fff;" onclick="treeNav('root')">«</button>
                <button style="padding:15px; background:#161b22; color:#fff;" onclick="treeNav('prev')">‹</button>
                <button style="padding:15px; background:#161b22; color:#fff;" onclick="treeNav('next')">›</button>
                <button style="padding:15px; background:#161b22; color:#fff;" onclick="treeNav('end')">»</button>
            </div>

            <button onclick="$('#modal-import').show()" style="width:100%; margin-top:15px; padding:15px; background:#161b22; color:var(--accent); border:1px solid var(--border)">IMPORTAR PGN</button>
        </div>

        <div class="analysis-section">
            <div id="comment-display">Carga un PGN para empezar...</div>
            <div id="notation-engine"></div>
        </div>
    </div>

    <div id="modal-import" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--accent)">Pegar PGN</h3>
            <textarea id="import-area" class="input-pro" style="height:200px" placeholder="Pega aquí el PGN de Lichess o Chess.com..."></textarea>
            <button class="btn-main" onclick="processImport()">CARGAR</button>
            <button onclick="$('.modal-overlay').hide()" style="width:100%; background:none; color:#555; margin-top:10px">Cancelar</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        let game = new Chess(), board = null;
        let tree = { root: { id: 'root', fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1', san: '', comment: '', parent: null, children: [] } };
        let cursor = tree.root;

        $(document).ready(() => { 
            // FIX PIEZAS: Usar tema de Wikipedia oficial
            board = ChessBoard('chessBoard', {
                draggable: true,
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: (s, t) => {
                    const move = game.move({from: s, to: t, promotion: 'q'});
                    if (!move) return 'snapback';
                    game.undo();
                    // Lógica de añadir nodo manual
                    let node = { id: 'n'+Math.random(), fen: game.fen(), san: move.san, comment: '', parent: cursor, children: [] };
                    cursor.children.push(node);
                    cursor = node; sync();
                }
            });
            sync();
        });

        // PROCESADOR DE PGN CON VARIANTES (Limpia paréntesis para no romperse)
        function processImport() {
            let pgn = $('#import-area').val();
            if (!pgn) return;

            // 1. Limpiar variantes (Todo lo que esté entre paréntesis)
            // Esto evita que el motor se pierda en las ramas secundarias
            pgn = pgn.replace(/\([^()]*\)/g, ''); 
            
            // 2. Extraer comentarios y movimientos
            const moveRegex = /([NBKRQ]?[a-h]?[1-8]?x?[a-h][1-8][+#]?|O-O-O|O-O)(\s+\{[^}]+\})?/g;
            let tempGame = new Chess();
            tree.root.children = [];
            let current = tree.root;
            let match;

            while ((match = moveRegex.exec(pgn)) !== null) {
                const san = match[1];
                const comment = match[2] ? match[2].replace(/[\{\}]/g, '').trim() : "";
                
                const validMove = tempGame.move(san);
                if (validMove) {
                    let node = {
                        id: 'n' + Math.random(),
                        fen: tempGame.fen(),
                        san: validMove.san,
                        comment: comment,
                        parent: current,
                        children: []
                    };
                    current.children.push(node);
                    current = node;
                }
            }

            cursor = tree.root;
            sync();
            $('.modal-overlay').hide();
        }

        function sync() {
            game.load(cursor.fen);
            board.position(game.fen());
            $('#comment-display').html(cursor.comment ? `<b>ANÁLISIS:</b> ${cursor.comment}` : "<i>Sin comentarios en esta posición</i>");
            renderNotation();
        }

        function renderNotation() {
            const html = buildNotationHTML(tree.root.children);
            $('#notation-engine').html(html);
        }

        function buildNotationHTML(nodes) {
            let h = "";
            nodes.forEach(n => {
                const activeClass = n.id === cursor.id ? 'm-active' : '';
                const commentHtml = n.comment ? `<span class="comm-inline">${n.comment}</span>` : '';
                h += `<span class="m-link ${activeClass}" onclick="jump('${n.id}')">${n.san}</span>${commentHtml} `;
                if (n.children.length > 0) h += buildNotationHTML([n.children[0]]);
            });
            return h;
        }

        function jump(id) {
            const node = findNode(tree.root, id);
            if (node) { cursor = node; sync(); }
        }

        function findNode(node, id) {
            if (node.id === id) return node;
            for (let c of node.children) {
                let res = findNode(c, id);
                if (res) return res;
            }
            return null;
        }

        function treeNav(dir) {
            if (dir === 'root') jump('root');
            if (dir === 'prev' && cursor.parent) jump(cursor.parent.id);
            if (dir === 'next' && cursor.children.length > 0) jump(cursor.children[0].id);
            if (dir === 'end') { let t = cursor; while(t.children.length > 0) t = t.children[0]; jump(t.id); }
        }
    </script>
</body>
</html>
