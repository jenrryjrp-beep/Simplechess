<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Lab v7.6 - Pro Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-body: #05070a; --bg-card: #0f1216; --accent: #00a8ff;
            --text-high: #ffffff; --border: #1e252b; --board-size: 520px;
            --c-brilliant: #26c2a3; --c-great: #5c8bb0; --c-book: #d5a47d; --c-blunder: #fa412d; --c-mistake: #ffcc00;
        }

        html, body { background: var(--bg-body); color: var(--text-high); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw; position: fixed; }
        .app-container { width: 100%; height: 100%; display: grid; grid-template-columns: 1fr 450px; padding: 15px; gap: 20px; box-sizing: border-box; overflow: hidden; }
        @media (max-width: 950px) { .app-container { grid-template-columns: 1fr; overflow-y: auto; position: relative; } html, body { position: relative; overflow: auto; height: auto; } }

        .board-frame { width: 100%; max-width: var(--board-size); position: relative; margin: 0 auto; touch-action: none; user-select: none; }
        #chessBoard { border: 4px solid var(--border); border-radius: 8px; margin: 10px 0; }
        #glyph-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        .glyph-badge { position: absolute; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; color: white; border: 2px solid #000; z-index: 1001; transform: translate(-50%, -50%); }

        .player-tag { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; font-weight: 700; font-size: 16px; }
        .elo-badge { background: rgba(0, 168, 255, 0.1); color: var(--accent); padding: 3px 12px; border-radius: 6px; font-family: 'Fira Code'; font-size: 13px; border: 1px solid rgba(0, 168, 255, 0.2); margin-left: 20px; }

        .analysis-section { background: var(--bg-card); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); height: 100%; }
        #comment-display { padding: 15px; min-height: 45px; background: #12151a; color: var(--accent); font-size: 14px; border-bottom: 1px solid var(--border); border-left: 4px solid var(--accent); white-space: pre-wrap; }
        #notation-engine { flex-grow: 1; padding: 20px; overflow-y: auto; background: #080a0d; line-height: 2.3; }
        .m-link { padding: 1px 5px; cursor: pointer; border-radius: 4px; color: #8892b0; display: inline-block; }
        .m-active { background: var(--accent) !important; color: #000 !important; font-weight: 700; }
        .comm-inline { display: block; font-size: 12px; color: #64748b; font-style: italic; margin: 2px 0 6px 15px; border-left: 2px solid #1e252b; padding-left: 8px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 15px; width: 90%; max-width: 480px; border: 1px solid var(--border); position: relative; }
        .close-modal { position: absolute; top: 12px; right: 12px; background: #fa412d; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .input-pro { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; }
        .btn-nav { padding: 18px; background: #161b22; color: #fff; border: 1px solid var(--border); border-radius: 8px; font-size: 22px; cursor: pointer; }
        .btn-sign { border: 1px solid transparent; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; height: 38px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="board-section">
            <div class="player-tag" id="p-top"></div>
            <div id="match-result" style="text-align:center; color:var(--accent); font-weight:900; letter-spacing:4px; margin:5px 0">*</div>
            <div class="board-frame" id="board-container">
                <div id="chessBoard"></div>
                <div id="glyph-layer"></div>
            </div>
            <div class="player-tag" id="p-bot"></div>
            
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-top:10px">
                <button class="btn-nav" onclick="treeNav('root')">¬´</button>
                <button class="btn-nav" onclick="treeNav('prev')">‚Äπ</button>
                <button class="btn-nav" onclick="treeNav('next')">‚Ä∫</button>
                <button class="btn-nav" onclick="treeNav('end')">¬ª</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                <button onclick="$('#modal-import').show()" style="padding:15px; background:#161b22; color:var(--accent); font-weight:bold; border:1px solid var(--border); border-radius:10px; cursor:pointer;">IMPORTAR PGN</button>
                <button onclick="exportAndCopy()" style="padding:15px; background:#161b22; color:#fff; font-weight:bold; border:1px solid var(--border); border-radius:10px; cursor:pointer;">EXPORTAR / COPIAR</button>
            </div>
            <button onclick="toggleSecret(true)" style="width:100%; margin-top:10px; padding:15px; background:var(--accent); color:#000; font-weight:900; border:none; border-radius:10px; cursor:pointer;">AJUSTES ‚öôÔ∏è</button>
        </div>

        <div class="analysis-section">
            <div id="comment-display"></div>
            <div id="notation-engine"></div>
            <button onclick="openNoteModal()" style="padding:20px; background:#161b22; color:var(--accent); border:none; font-weight:bold; cursor:pointer; border-top:1px solid var(--border)">SIGNOS Y COMENTARIOS üìù</button>
        </div>
    </div>

    <div id="modal-import" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="$('.modal-overlay').hide()">X</button>
            <h3 style="color:var(--accent); margin-top:0">Importar PGN</h3>
            <textarea id="import-area" class="input-pro" style="height:250px; font-size:11px" placeholder="Pega el PGN aqu√≠..."></textarea>
            <button onclick="processImport()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:bold">CARGAR PARTIDA</button>
        </div>
    </div>

    <div id="modal-note" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="$('.modal-overlay').hide()">X</button>
            <textarea id="note-input" class="input-pro" style="height:100px" placeholder="Comentario..."></textarea>
            <button onclick="saveNote()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:bold;">GUARDAR</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        const GLYPH_COLORS = { '!!': '#26c2a3', '!': '#5c8bb0', 'üìñ': '#d5a47d', '??': '#fa412d', '?': '#ffcc00' };
        let game = new Chess(), board = null;
        let match = { w: 'Blancas', we: '?', b: 'Negras', be: '?', res: '*' };
        let tree = { root: { id: 'root', fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1', san: '', sign: '', comment: '', parent: null, children: [] } };
        let cursor = tree.root;

        $(document).ready(() => { 
            initBoard(); 
            sync();
        });

        function initBoard() {
            board = ChessBoard('chessBoard', {
                draggable: true, position: 'start',
                onDrop: (s, t) => { 
                    const m = game.move({from: s, to: t, promotion: 'q'});
                    if (!m) return 'snapback';
                    game.undo(); execMove(s, t);
                }
            });
        }

        function execMove(s, t) {
            game.load(cursor.fen);
            const move = game.move({from: s, to: t, promotion: 'q'});
            let node = cursor.children.find(c => c.san === move.san);
            if (!node) {
                node = { id: 'n'+Math.random().toString(36).substr(2,9), fen: game.fen(), san: move.san, lastSq: t, sign: '', comment: '', parent: cursor, children: [] };
                cursor.children.push(node);
            }
            cursor = node; sync();
        }

        // TRADUCTOR PGN MEJORADO (SIN DEPENDENCIAS EXTERNAS)
        function processImport() {
            const raw = $('#import-area').val();
            if (!raw) return;

            try {
                // Tags
                match.w = raw.match(/\[White\s+"(.*?)"\]/)?.[1] || "Blancas";
                match.we = raw.match(/\[WhiteElo\s+"(.*?)"\]/)?.[1] || "?";
                match.b = raw.match(/\[Black\s+"(.*?)"\]/)?.[1] || "Negras";
                match.be = raw.match(/\[BlackElo\s+"(.*?)"\]/)?.[1] || "?";
                match.res = raw.match(/\[Result\s+"(.*?)"\]/)?.[1] || "*";

                // Limpieza de jugadas y comentarios
                let tempGame = new Chess();
                tree.root.children = [];
                let current = tree.root;

                // Extraer movimientos y sus comentarios asociados
                // Esta regex busca: Jugada SAN y opcionalmente un comentario { ... }
                const moveRegex = /([NBKRQ]?[a-h]?[1-8]?x?[a-h][1-8][+#]?|O-O-O|O-O)(\s+\{[^}]+\})?/g;
                let matchMove;

                while ((matchMove = moveRegex.exec(raw)) !== null) {
                    const san = matchMove[1];
                    const comment = matchMove[2] ? matchMove[2].replace(/[\{\}]/g, '').trim() : "";
                    
                    const move = tempGame.move(san);
                    if (move) {
                        let node = {
                            id: 'n' + Math.random().toString(36).substr(2, 9),
                            fen: tempGame.fen(),
                            san: move.san,
                            lastSq: move.to,
                            sign: '',
                            comment: comment,
                            parent: current,
                            children: []
                        };
                        current.children.push(node);
                        current = node;
                    }
                }

                cursor = tree.root;
                sync();
                $('.modal-overlay').hide();
            } catch (e) {
                alert("Error procesando PGN");
            }
        }

        function sync() {
            game.load(cursor.fen); 
            board.position(game.fen(), false);
            $('#p-top').html(`<span>${match.b}</span><span class="elo-badge">${match.be}</span>`);
            $('#p-bot').html(`<span>${match.w}</span><span class="elo-badge">${match.we}</span>`);
            $('#match-result').text(match.res);
            $('#comment-display').html(cursor.comment ? `<b>AN√ÅLISIS:</b> ${cursor.comment}` : "<i>Sin comentarios</i>");
            renderNotation();
        }

        function renderNotation() {
            const eng = document.getElementById('notation-engine');
            eng.innerHTML = buildTreeUI(tree.root.children);
        }

        function buildTreeUI(nodes) {
            let h = "";
            nodes.forEach((n) => {
                const cLabel = n.comment ? `<span class="comm-inline">${n.comment}</span>` : '';
                h += ` <span class="m-link ${n.id===cursor.id?'m-active':''}" onclick="jump('${n.id}')">${n.san}</span>${cLabel}`;
                if (n.children.length > 0) h += buildTreeUI([n.children[0]]);
            });
            return h;
        }

        function jump(id) {
            const found = findInTree(tree.root, id);
            if (found) { cursor = found; sync(); }
        }

        function findInTree(node, id) {
            if (node.id === id) return node;
            for (let child of node.children) {
                const res = findInTree(child, id);
                if (res) return res;
            }
            return null;
        }

        function treeNav(action) {
            if (action === 'root') jump('root');
            if (action === 'prev' && cursor.parent) jump(cursor.parent.id);
            if (action === 'next' && cursor.children.length > 0) jump(cursor.children[0].id);
            if (action === 'end') { let t = cursor; while(t.children.length > 0) t = t.children[0]; jump(t.id); }
        }

        function openNoteModal() { $('#note-input').val(cursor.comment || ""); $('#modal-note').show(); }
        function saveNote() { cursor.comment = $('#note-input').val(); $('.modal-overlay').hide(); sync(); }
        function toggleSecret(o) { alert("Ajustes abiertos (Funcionalidad base)"); }
    </script>
</body>
</html>
